<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OZ Diary - ìœ ì € ìŠ¤í† ë¦¬ ë°˜ì˜ë³¸</title>
    <style>
        :root { --primary: #228be6; --bg: #f8f9fa; --card: #ffffff; --text: #333; }
        body { font-family: 'Pretendard', sans-serif; margin: 0; background-color: var(--bg); color: var(--text); line-height: 1.6; }
        .container { max-width: 800px; margin: 40px auto; background: var(--card); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }

        /* ìœ ì € ìŠ¤í† ë¦¬: ëª…ì–¸ & ì§ˆë¬¸ ì„¹ì…˜ */
        .info-box { background-color: #fff9db; border-left: 5px solid #fcc419; padding: 20px; margin-bottom: 25px; border-radius: 8px; position: relative; }
        .bookmark-btn { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 20px; border: none; background: none; }
        .question-box { background-color: #e7f5ff; border-left: 5px solid #339af0; padding: 15px; margin-bottom: 25px; border-radius: 8px; font-weight: 500; }

        h1, h2 { color: var(--primary); margin-top: 0; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { padding: 12px 24px; background-color: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button:hover { filter: brightness(0.9); }
        .error { color: #fa5252; font-size: 14px; margin-bottom: 15px; }
        .diary-item { background: #f1f3f5; padding: 20px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div id="main-display" class="hidden">
            <div class="question-box" id="daily-question">ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div class="info-box">
                <button class="bookmark-btn" onclick="bookmarkQuote()" title="ë¶ë§ˆí¬">â­</button>
                <div id="quote-content">"ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."</div>
                <small id="quote-author" style="display:block; margin-top:10px; text-align:right;"></small>
            </div>
        </div>

        <h1>OZ Diary</h1>

        <div id="auth-section">
            <p>ê³„ì •ì„ ìƒì„±í•˜ê³  ì¼ìƒì„ ê¸°ë¡í•´ë³´ì„¸ìš”.</p>
            <div class="error" id="auth-error"></div>
            <input type="email" id="email" placeholder="ì´ë©”ì¼ (í•„ìˆ˜)">
            <input type="text" id="username" placeholder="ì‚¬ìš©ì ì´ë¦„ (íšŒì›ê°€ì… ì‹œ)">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)">
            <button onclick="auth('login')">ë¡œê·¸ì¸</button>
            <button style="background-color: #adb5bd;" onclick="auth('signup')">íšŒì›ê°€ì…</button>
        </div>

        <div id="diary-section" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>ë‚˜ì˜ ê¸°ë¡</h2>
                <button style="background-color: #fa5252;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <input type="text" id="diary-title" placeholder="ì œëª©">
            <textarea id="diary-content" rows="4" placeholder="ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
            <button onclick="createDiary()">ê¸°ë¡í•˜ê¸°</button>

            <div id="diary-list" style="margin-top:40px;"></div>
        </div>
    </div>

    <script>
        let currentQuoteId = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('token')) {
                loadMainContent();
            }
        });

        // 1. ìœ ì € ìŠ¤í† ë¦¬: ê³„ì • ìƒì„± ë° ë¡œê·¸ì¸
        async function auth(type) {
            const email = document.getElementById('email').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const path = type === 'login' ? '/auth/login' : '/auth/register';
            const payload = type === 'login' ? { email, password } : { email, username, password };

            try {
                const res = await fetch(path, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok) {
                    if (type === 'login') {
                        localStorage.setItem('token', data.access_token);
                        loadMainContent();
                    } else alert('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                } else document.getElementById('auth-error').textContent = JSON.stringify(data.detail);
            } catch (e) { alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨'); }
        }

        // 2. ìœ ì € ìŠ¤í† ë¦¬: ë¡œê·¸ì•„ì›ƒ ë° ì„¸ì…˜ ì¢…ë£Œ
        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        function loadMainContent() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('diary-section').classList.remove('hidden');
            document.getElementById('main-display').classList.remove('hidden');
            fetchRandomQuote();
            fetchRandomQuestion();
            fetchDiaries();
        }

        // 3. ìœ ì € ìŠ¤í† ë¦¬: ëœë¤ ëª…ì–¸ ë° ë¶ë§ˆí¬
        async function fetchRandomQuote() {
            const res = await fetch('/quote/random');
            if (res.ok) {
                const data = await res.json();
                currentQuoteId = data.id;
                document.getElementById('quote-content').textContent = `"${data.content}"`;
                document.getElementById('quote-author').textContent = `- ${data.author || 'ì‘ì ë¯¸ìƒ'}`;
            }
        }

        async function bookmarkQuote() {
            const token = localStorage.getItem('token');
            const res = await fetch(`/quote/${currentQuoteId}/bookmark`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) alert('ëª…ì–¸ì„ ë¶ë§ˆí¬í–ˆìŠµë‹ˆë‹¤!');
        }

        // 4. ìœ ì € ìŠ¤í† ë¦¬: ëœë¤ ìê¸°ì„±ì°° ì§ˆë¬¸
        async function fetchRandomQuestion() {
            const token = localStorage.getItem('token');
            const res = await fetch('/questions/random', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                document.getElementById('daily-question').textContent = `ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ${data.content}`;
            }
        }

        // 5. ìœ ì € ìŠ¤í† ë¦¬: ì¼ê¸° ì¡°íšŒ, ìƒì„±, ì‚­ì œ (ìˆ˜ì •ì€ í”„ë¡¬í”„íŠ¸ ëŒ€ì²´)
        async function fetchDiaries() {
            const token = localStorage.getItem('token');
            const res = await fetch('/v1/diary/', { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                const diaries = await res.json();
                const list = document.getElementById('diary-list');
                list.innerHTML = diaries.length ? '' : '<p>ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                diaries.forEach(d => {
                    const item = document.createElement('div');
                    item.className = 'diary-item';
                    item.innerHTML = `
                        <div><strong>${d.title}</strong><br><small>${d.content}</small></div>
                        <div>
                            <button onclick="updateDiary(${d.id}, '${d.title}', '${d.content}')">ìˆ˜ì •</button>
                            <button style="background:#fa5252;" onclick="deleteDiary(${d.id})">ì‚­ì œ</button>
                        </div>`;
                    list.appendChild(item);
                });
            }
        }

        async function createDiary() {
            const title = document.getElementById('diary-title').value;
            const content = document.getElementById('diary-content').value;
            const token = localStorage.getItem('token');
            await fetch('/v1/diary/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ title, content })
            });
            fetchDiaries();
        }

        async function updateDiary(id, oldT, oldC) {
            const title = prompt('ìˆ˜ì •í•  ì œëª©:', oldT) || oldT;
            const content = prompt('ìˆ˜ì •í•  ë‚´ìš©:', oldC) || oldC;
            const token = localStorage.getItem('token');
            await fetch(`/v1/diary/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ title, content })
            });
            fetchDiaries();
        }

        async function deleteDiary(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const token = localStorage.getItem('token');
            await fetch(`/v1/diary/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            fetchDiaries();
        }
    </script>
</body>
</html>
