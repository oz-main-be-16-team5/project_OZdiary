<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OZ Diary</title>
  <style>
    :root { --primary:#228be6; --bg:#f8f9fa; --card:#fff; --text:#333; }
    body { margin:0; font-family:Pretendard, sans-serif; background:var(--bg); color:var(--text); line-height:1.6; }
    .container { max-width:800px; margin:40px auto; background:var(--card); padding:40px; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,.05); }

    .info-box { background:#fff9db; border-left:5px solid #fcc419; padding:20px; margin-bottom:25px; border-radius:8px; position:relative; }
    .bookmark-btn { position:absolute; top:15px; right:15px; cursor:pointer; font-size:20px; border:none; background:none; }
    .question-box { background:#e7f5ff; border-left:5px solid #339af0; padding:15px; margin-bottom:25px; border-radius:8px; font-weight:500; }

    h1,h2 { color:var(--primary); margin-top:0; }
    input, textarea { width:100%; padding:12px; margin-bottom:15px; border:1px solid #dee2e6; border-radius:8px; box-sizing:border-box; font-size:16px; }
    button { padding:12px 24px; background:var(--primary); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition:.2s; }
    button:hover { filter:brightness(.9); }
    .error { color:#fa5252; font-size:14px; margin-bottom:15px; }
    .diary-item { background:#f1f3f5; padding:20px; border-radius:12px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <div id="main-display" class="hidden">
      <div class="question-box" id="daily-question">ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <div class="info-box">
        <button class="bookmark-btn" onclick="bookmarkQuote()" title="ë¶ë§ˆí¬">â­</button>
        <div id="quote-content">"ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."</div>
        <small id="quote-author" style="display:block; margin-top:10px; text-align:right;"></small>
      </div>
    </div>

    <h1>OZ Diary</h1>

    <div id="auth-section">
      <p>ê³„ì •ì„ ìƒì„±í•˜ê³  ì¼ìƒì„ ê¸°ë¡í•´ë³´ì„¸ìš”.</p>
      <div class="error" id="auth-error"></div>
      <input type="email" id="email" placeholder="ì´ë©”ì¼ (í•„ìˆ˜)" />
      <input type="text" id="username" placeholder="ì‚¬ìš©ì ì´ë¦„ (íšŒì›ê°€ì… ì‹œ)" />
      <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)" />
      <button onclick="auth('login')">ë¡œê·¸ì¸</button>
      <button style="background-color:#adb5bd;" onclick="auth('signup')">íšŒì›ê°€ì…</button>
    </div>

    <div id="diary-section" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>ë‚˜ì˜ ê¸°ë¡</h2>
        <button style="background-color:#fa5252;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>

      <input type="text" id="diary-title" placeholder="ì œëª©" />
      <textarea id="diary-content" rows="4" placeholder="ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
      <button onclick="createDiary()">ê¸°ë¡í•˜ê¸°</button>

      <div id="diary-list" style="margin-top:40px;"></div>
    </div>
  </div>

  <script>
    /*****************************************************************
     * âœ… í™•ì • ì—”ë“œí¬ì¸íŠ¸
     * - ì§ˆë¬¸: /questions/random
     * - ëª…ì–¸: /quote/random
     * - ì¼ê¸°: /v1/diary/
     *
     * âœ… ìˆ˜ì • ë²„íŠ¼ ì•ˆ ë¨¹ëŠ” ë¬¸ì œ í•´ê²°
     * - onclickì— '${d.title}' ê°™ì€ ë¬¸ìì—´ì„ ì§ì ‘ ë„£ìœ¼ë©´
     *   ì œëª©/ë‚´ìš©ì— ' (ì‘ì€ë”°ì˜´í‘œ) ë“¤ì–´ê°€ëŠ” ìˆœê°„ HTML/JSê°€ ê¹¨ì ¸ì„œ ìˆ˜ì •ë§Œ ì•ˆ ë¨
     * - í•´ê²°: ë²„íŠ¼ì— addEventListenerë¡œ ì•ˆì „í•˜ê²Œ ê°’ ì „ë‹¬
     *****************************************************************/

    const QUESTION_CACHE_KEY = "today_question_cache_v1";
    let currentQuoteId = null;

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('token')) {
        loadMainContent();
      }
    });

    // ---------- AUTH ----------
    async function auth(type) {
      const email = document.getElementById('email').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      document.getElementById('auth-error').textContent = "";

      const path = type === 'login' ? '/auth/login' : '/auth/register';
      const payload = type === 'login' ? { email, password } : { email, username, password };

      try {
        const res = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const raw = await res.text();
        let data;
        try { data = JSON.parse(raw); } catch { data = { detail: raw }; }

        if (!res.ok) {
          document.getElementById('auth-error').textContent = JSON.stringify(data.detail || data);
          console.log("auth failed:", res.status, data);
          return;
        }

        if (type === 'login') {
          const token = data.access_token || data.token || data.accessToken;
          if (!token) {
            document.getElementById('auth-error').textContent =
              "ë¡œê·¸ì¸ ì‘ë‹µì— í† í°(access_token)ì´ ì—†ìŠµë‹ˆë‹¤. ì½˜ì†” í™•ì¸!";
            console.log("login response:", data);
            return;
          }
          localStorage.setItem('token', token);
          loadMainContent();
        } else {
          alert('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        }
      } catch (e) {
        alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
        console.log(e);
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem(QUESTION_CACHE_KEY);
      location.reload();
    }

    function loadMainContent() {
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('diary-section').classList.remove('hidden');
      document.getElementById('main-display').classList.remove('hidden');

      fetchRandomQuote();
      showCachedOrFetchQuestion();
      fetchDiaries();
    }

    // ---------- QUOTE ----------
    async function fetchRandomQuote() {
      try {
        const res = await fetch('/quote/random');
        if (!res.ok) {
          const raw = await res.text();
          document.getElementById('quote-content').textContent = `"ëª…ì–¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (${res.status})"`;
          document.getElementById('quote-author').textContent = "";
          console.log("/quote/random failed:", res.status, raw);
          return;
        }

        const data = await res.json();
        currentQuoteId = data.id;
        document.getElementById('quote-content').textContent = `"${data.content || data.text || ''}"`;
        document.getElementById('quote-author').textContent = `- ${data.author || 'ì‘ì ë¯¸ìƒ'}`;
      } catch (e) {
        document.getElementById('quote-content').textContent = `"ëª…ì–¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"`;
        document.getElementById('quote-author').textContent = "";
        console.log("fetchRandomQuote error:", e);
      }
    }

    async function bookmarkQuote() {
      const token = localStorage.getItem('token');
      if (!token) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      if (!currentQuoteId) return alert("ë¶ë§ˆí¬í•  ëª…ì–¸ì´ ì—†ìŠµë‹ˆë‹¤.");

      const res = await fetch(`/quote/${currentQuoteId}/bookmark`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (res.ok) alert('ëª…ì–¸ì„ ë¶ë§ˆí¬í–ˆìŠµë‹ˆë‹¤!');
      else {
        const raw = await res.text();
        alert(`ë¶ë§ˆí¬ ì‹¤íŒ¨ (${res.status})`);
        console.log("bookmark failed:", res.status, raw);
      }
    }

    // ---------- QUESTION (ìºì‹œ + undefined ë°©ì§€ + 400 ë¬¸êµ¬) ----------
    function todayKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function writeQuestionCache(questionText) {
      localStorage.setItem(QUESTION_CACHE_KEY, JSON.stringify({ date: todayKey(), question: questionText }));
    }

    function readQuestionCache() {
      const raw = localStorage.getItem(QUESTION_CACHE_KEY);
      if (!raw) return null;
      try {
        const parsed = JSON.parse(raw);
        if (parsed.date !== todayKey()) return null;
        return parsed;
      } catch {
        return null;
      }
    }

    function showCachedOrFetchQuestion() {
      const cached = readQuestionCache();
      if (cached && cached.question) {
        document.getElementById('daily-question').textContent = `ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ${cached.question}`;
        return;
      }
      fetchRandomQuestion();
    }

    async function fetchRandomQuestion() {
      const token = localStorage.getItem('token');
      if (!token) {
        document.getElementById('daily-question').textContent = 'ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: (ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤)';
        return;
      }

      try {
        const res = await fetch('/questions/random', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
          if (res.status === 400) {
            const cached = readQuestionCache();
            document.getElementById('daily-question').textContent =
              cached?.question
                ? `ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ${cached.question}`
                : 'ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ì˜¤ëŠ˜ì€ ì§ˆë¬¸ì„ ì´ë¯¸ í•œë²ˆ ë°›ìœ¼ì…¨ìŠµë‹ˆë‹¤ ğŸ˜Š';
            return;
          }

          const raw = await res.text();
          document.getElementById('daily-question').textContent = `ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: (ìš”ì²­ ì‹¤íŒ¨ ${res.status})`;
          console.log("/questions/random failed:", res.status, raw);
          return;
        }

        const data = await res.json();

        // âœ… contentê°€ ì•„ë‹ˆë¼ë„ ì»¤ë²„í•´ì„œ undefined ë°©ì§€
        const q =
          data.content ||
          data.question ||
          data.text ||
          data.message ||
          (data.data && (data.data.content || data.data.question || data.data.text));

        if (!q) {
          document.getElementById('daily-question').textContent =
            'ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: (ì§ˆë¬¸ ë°ì´í„° í˜•ì‹ì´ ë‹¬ë¼ìš”. ì½˜ì†” í™•ì¸!)';
          console.log("questions/random unknown shape:", data);
          return;
        }

        document.getElementById('daily-question').textContent = `ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ${q}`;
        writeQuestionCache(q);
      } catch (e) {
        document.getElementById('daily-question').textContent = 'ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: (ì„œë²„ ì—°ê²° ì‹¤íŒ¨)';
        console.log("fetchRandomQuestion error:", e);
      }
    }

    // ---------- DIARY ----------
    async function fetchDiaries() {
      const token = localStorage.getItem('token');
      if (!token) return;

      const res = await fetch('/v1/diary/', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) {
        const raw = await res.text();
        console.log("/v1/diary/ failed:", res.status, raw);
        return;
      }

      const diaries = await res.json();
      const list = document.getElementById('diary-list');
      list.innerHTML = diaries.length ? '' : '<p>ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

      diaries.forEach(d => {
        const item = document.createElement('div');
        item.className = 'diary-item';

        item.innerHTML = `
          <div>
            <strong>${escapeHtml(d.title ?? "")}</strong><br>
            <small>${escapeHtml(d.content ?? "")}</small>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="edit-btn">ìˆ˜ì •</button>
            <button class="del-btn" style="background:#fa5252;">ì‚­ì œ</button>
          </div>
        `;

        // âœ… í•µì‹¬: onclickì— ë¬¸ìì—´ ë¼ì›Œ ë„£ì§€ ë§ê³  ì´ë²¤íŠ¸ë¡œ ì•ˆì „í•˜ê²Œ ì „ë‹¬
        item.querySelector('.edit-btn').addEventListener('click', () => {
          updateDiary(d.id, d.title ?? "", d.content ?? "");
        });

        item.querySelector('.del-btn').addEventListener('click', () => {
          deleteDiary(d.id);
        });

        list.appendChild(item);
      });
    }

    async function createDiary() {
      const title = document.getElementById('diary-title').value;
      const content = document.getElementById('diary-content').value;
      const token = localStorage.getItem('token');

      const res = await fetch('/v1/diary/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ title, content })
      });

      if (!res.ok) {
        const raw = await res.text();
        alert(`ì¼ê¸° ìƒì„± ì‹¤íŒ¨ (${res.status})`);
        console.log("createDiary failed:", res.status, raw);
        return;
      }

      document.getElementById('diary-title').value = "";
      document.getElementById('diary-content').value = "";
      fetchDiaries();
    }

    async function updateDiary(id, oldT, oldC) {
      const title = prompt('ìˆ˜ì •í•  ì œëª©:', oldT);
      const content = prompt('ìˆ˜ì •í•  ë‚´ìš©:', oldC);

      // ì·¨ì†Œí•˜ë©´ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
      if (title === null && content === null) return;

      const token = localStorage.getItem('token');

      const res = await fetch(`/v1/diary/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({
          title: title === null ? oldT : title,
          content: content === null ? oldC : content
        })
      });

      if (!res.ok) {
        const raw = await res.text();
        alert(`ì¼ê¸° ìˆ˜ì • ì‹¤íŒ¨ (${res.status})`);
        console.log("updateDiary failed:", res.status, raw);
        return;
      }

      fetchDiaries();
    }

    async function deleteDiary(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const token = localStorage.getItem('token');
      const res = await fetch(`/v1/diary/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) {
        const raw = await res.text();
        alert(`ì¼ê¸° ì‚­ì œ ì‹¤íŒ¨ (${res.status})`);
        console.log("deleteDiary failed:", res.status, raw);
        return;
      }

      fetchDiaries();
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
