<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OZ Diary</title>
  <style>
    :root { --primary:#228be6; --bg:#f8f9fa; --card:#fff; --text:#333; --danger:#fa5252; --success:#40c057; }
    body { margin:0; font-family:Pretendard, sans-serif; background:var(--bg); color:var(--text); line-height:1.6; }
    .container { max-width:800px; margin:40px auto; background:var(--card); padding:40px; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,.05); }

    .info-box { background:#fff9db; border-left:5px solid #fcc419; padding:20px; margin-bottom:18px; border-radius:8px; position:relative; }
    .question-box { background:#e7f5ff; border-left:5px solid #339af0; padding:15px; margin-bottom:18px; border-radius:8px; font-weight:500; }

    h1,h2 { color:var(--primary); margin-top:0; }
    input, textarea { width:100%; padding:12px; margin-bottom:15px; border:1px solid #dee2e6; border-radius:8px; box-sizing:border-box; font-size:16px; }
    button { padding:12px 16px; background:var(--primary); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition:.2s; }
    button:hover { filter:brightness(.92); }
    .btn-danger { background:var(--danger); }
    .btn-success { background:var(--success); }
    .btn-gray { background:#adb5bd; }
    .error { color:var(--danger); font-size:14px; margin-bottom:15px; }
    .diary-item { background:#f1f3f5; padding:20px; border-radius:12px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .hidden { display:none; }
    .muted { color:#868e96; font-size:14px; }

    /* â­ í† ê¸€ìš© ë³„ ë²„íŠ¼ */
    .bookmark-btn {
      position:absolute; top:14px; right:14px;
      border:none; background:none; cursor:pointer;
      font-size:22px; line-height:1;
      transition:.15s;
    }
    .bookmark-btn:hover { transform: scale(1.08); }
    .bookmark-btn.on { color:#fcc419; } /* ì±„ì›Œì§„ ëŠë‚Œ */
    .bookmark-btn.off { color:#adb5bd; } /* ë¹„í™œì„± ëŠë‚Œ */

    .row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:18px; }
    .row button { flex: 1; min-width: 220px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- ë¡œê·¸ì¸ í›„ ìƒë‹¨ í‘œì‹œ ì˜ì—­ -->
    <div id="main-display" class="hidden">
      <div class="question-box" id="daily-question">ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

      <!-- ëœë¤ ëª…ì–¸ ì¹´ë“œ -->
      <div class="info-box" id="quote-card">
        <button id="bookmark-btn" class="bookmark-btn off" onclick="toggleBookmark()" title="ë¶ë§ˆí¬">â˜†</button>
        <div id="quote-content">"ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."</div>
        <small id="quote-author" style="display:block; margin-top:10px; text-align:right;"></small>
        <div class="muted" id="quote-status" style="margin-top:10px;"></div>
      </div>

      <!-- ë¶ë§ˆí¬ ì•¡ì…˜ ë²„íŠ¼ -->
      <div class="row">
        <button class="btn-success" onclick="fetchBookmarks()">â­ ë‚´ê°€ ë¶ë§ˆí¬í•œ ëª…ì–¸ ë³´ê¸°</button>
        <button class="btn-gray" onclick="hideBookmarks()">ìˆ¨ê¸°ê¸°</button>
      </div>

      <!-- ë¶ë§ˆí¬ ë¦¬ìŠ¤íŠ¸ -->
      <div id="bookmark-list" class="hidden"></div>
    </div>

    <h1>OZ Diary</h1>

    <!-- ì¸ì¦ ì˜ì—­ -->
    <div id="auth-section">
      <p>ê³„ì •ì„ ìƒì„±í•˜ê³  ì¼ìƒì„ ê¸°ë¡í•´ë³´ì„¸ìš”.</p>
      <div class="error" id="auth-error"></div>
      <input type="email" id="email" placeholder="ì´ë©”ì¼ (í•„ìˆ˜)" />
      <input type="text" id="username" placeholder="ì‚¬ìš©ì ì´ë¦„ (íšŒì›ê°€ì… ì‹œ)" />
      <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)" />
      <button onclick="auth('login')">ë¡œê·¸ì¸</button>
      <button class="btn-gray" onclick="auth('signup')">íšŒì›ê°€ì…</button>
    </div>

    <!-- ì¼ê¸° ì˜ì—­ -->
    <div id="diary-section" class="hidden">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>ë‚˜ì˜ ê¸°ë¡</h2>
        <button class="btn-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>

      <input type="text" id="diary-title" placeholder="ì œëª©" />
      <textarea id="diary-content" rows="4" placeholder="ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
      <button onclick="createDiary()">ê¸°ë¡í•˜ê¸°</button>

      <div id="diary-list" style="margin-top:40px;"></div>
    </div>
  </div>

  <script>
    /**
     * âœ… ë°±ì—”ë“œ ê¸°ì¤€ ì—”ë“œí¬ì¸íŠ¸(í† í° ê¸°ë°˜)
     * - Auth:   POST /auth/login, POST /auth/register
     * - Quote:  GET  /quote/random
     *          POST   /quote/{quote_id}/bookmark
     *          GET    /quote/bookmark
     *          DELETE /quote/{quote_id}/bookmark
     * - QnA:    GET  /questions/random
     * - Diary:  GET/POST /v1/diary/ , PUT/DELETE /v1/diary/{id}
     */

    const QUESTION_CACHE_KEY = "today_question_cache_v2";

    // í˜„ì¬ ëœë¤ ëª…ì–¸
    let currentQuoteId = null;

    // ë¶ë§ˆí¬ ìƒíƒœ ìºì‹œ(í”„ë¡ íŠ¸ìš©)
    // key: quoteId(number), value: true/false
    const bookmarkedMap = new Map();

    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("token")) loadMainContent();
    });

    // ---------- UTIL ----------
    function token() {
      return localStorage.getItem("token");
    }

    function authHeader() {
      const t = token();
      return t ? { Authorization: `Bearer ${t}` } : {};
    }

    async function readJsonSafe(res) {
      const raw = await res.text();
      try { return JSON.parse(raw); } catch { return { detail: raw }; }
    }

    function todayKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function readQuestionCache() {
      const raw = localStorage.getItem(QUESTION_CACHE_KEY);
      if (!raw) return null;
      try {
        const parsed = JSON.parse(raw);
        if (parsed.date !== todayKey()) return null;
        return parsed;
      } catch {
        return null;
      }
    }

    function writeQuestionCache(questionText) {
      localStorage.setItem(
        QUESTION_CACHE_KEY,
        JSON.stringify({ date: todayKey(), question: questionText })
      );
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setQuoteStatus(msg) {
      document.getElementById("quote-status").textContent = msg || "";
    }

    function setBookmarkIcon(isOn) {
      const btn = document.getElementById("bookmark-btn");
      btn.classList.toggle("on", !!isOn);
      btn.classList.toggle("off", !isOn);
      btn.textContent = isOn ? "â˜…" : "â˜†";
    }

    // ---------- AUTH ----------
    async function auth(type) {
      const email = document.getElementById("email").value.trim();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const authError = document.getElementById("auth-error");
      authError.textContent = "";

      const path = type === "login" ? "/auth/login" : "/auth/register";
      const payload = type === "login" ? { email, password } : { email, username, password };

      try {
        const res = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await readJsonSafe(res);

        if (!res.ok) {
          authError.textContent = typeof data.detail === "string" ? data.detail : JSON.stringify(data.detail);
          console.log("auth failed:", res.status, data);
          return;
        }

        if (type === "login") {
          const t = data.access_token;
          if (!t) {
            authError.textContent = "ë¡œê·¸ì¸ ì‘ë‹µì— access_tokenì´ ì—†ìŠµë‹ˆë‹¤.";
            console.log("login response:", data);
            return;
          }
          localStorage.setItem("token", t);
          loadMainContent();
        } else {
          alert("íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        }
      } catch (e) {
        alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
        console.log(e);
      }
    }

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem(QUESTION_CACHE_KEY);
      location.reload();
    }

    async function loadMainContent() {
      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("diary-section").classList.remove("hidden");
      document.getElementById("main-display").classList.remove("hidden");

      // âœ… ë¡œê·¸ì¸ ì§í›„ ë¶ë§ˆí¬ ëª©ë¡ì„ í•œ ë²ˆ ê°€ì ¸ì™€ì„œ "ë³„ ìƒíƒœ"ë¥¼ ë§ì¶°ë‘”ë‹¤
      await warmupBookmarks();

      await fetchRandomQuote();
      showCachedOrFetchQuestion();
      fetchDiaries();
    }

    // ---------- BOOKMARK WARMUP ----------
    async function warmupBookmarks() {
      bookmarkedMap.clear();
      const t = token();
      if (!t) return;

      const res = await fetch("/quote/bookmark", { headers: { ...authHeader() } });
      if (!res.ok) {
        // ë¶ë§ˆí¬ ëª©ë¡ì´ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ ê¸°ëŠ¥ì€ ë™ì‘í•˜ê²Œ ë‘ 
        const raw = await res.text();
        console.log("warmupBookmarks failed:", res.status, raw);
        return;
      }

      const quotes = await res.json();
      quotes.forEach(q => bookmarkedMap.set(Number(q.id), true));
    }

    // ---------- QUOTE ----------
    async function fetchRandomQuote() {
      setQuoteStatus("");
      try {
        const res = await fetch("/quote/random");
        if (!res.ok) {
          const data = await readJsonSafe(res);
          document.getElementById("quote-content").textContent = `"ëª…ì–¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (${res.status})"`;
          document.getElementById("quote-author").textContent = "";
          console.log("/quote/random failed:", res.status, data);
          return;
        }

        const data = await res.json();
        currentQuoteId = Number(data.id);

        document.getElementById("quote-content").textContent = `"${data.content || ""}"`;
        document.getElementById("quote-author").textContent = `- ${data.author || "ì‘ì ë¯¸ìƒ"}`;

        // âœ… í˜„ì¬ ëª…ì–¸ì´ ë¶ë§ˆí¬ ë˜ì–´ìˆìœ¼ë©´ ë³„ì„ ì±„ì›€
        setBookmarkIcon(bookmarkedMap.get(currentQuoteId) === true);
      } catch (e) {
        document.getElementById("quote-content").textContent = `"ëª…ì–¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"`;
        document.getElementById("quote-author").textContent = "";
        console.log("fetchRandomQuote error:", e);
      }
    }

    // â­ ë³„ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ: ë¶ë§ˆí¬ ì¶”ê°€/í•´ì œ í† ê¸€
    async function toggleBookmark() {
      if (!currentQuoteId) return alert("ëª…ì–¸ì„ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.");
      const isOn = bookmarkedMap.get(currentQuoteId) === true;

      if (isOn) {
        await removeBookmark(currentQuoteId, { silent: true });
      } else {
        await addBookmark(currentQuoteId, { silent: true });
      }

      // UI ë°˜ì˜
      setBookmarkIcon(bookmarkedMap.get(currentQuoteId) === true);

      // ë¶ë§ˆí¬ ë¦¬ìŠ¤íŠ¸ê°€ ì—´ë ¤ìˆìœ¼ë©´ ìµœì‹ í™”
      const list = document.getElementById("bookmark-list");
      if (!list.classList.contains("hidden")) {
        fetchBookmarks();
      }
    }

    async function addBookmark(quoteId, { silent = false } = {}) {
      if (!token()) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      setQuoteStatus("ë¶ë§ˆí¬ ì¶”ê°€ ì¤‘...");
      const res = await fetch(`/quote/${quoteId}/bookmark`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          ...authHeader() },
        body: JSON.stringify({})
      });

      if (res.ok) {
        const data = await readJsonSafe(res);
        bookmarkedMap.set(Number(quoteId), true);
        setQuoteStatus(data.message || "ë¶ë§ˆí¬ ì™„ë£Œ!");
        if (!silent) alert(data.message || "ë¶ë§ˆí¬ ì™„ë£Œ!");
        return true;
      }

      const raw = await res.text();
      setQuoteStatus(`ë¶ë§ˆí¬ ì‹¤íŒ¨ (${res.status})`);
      console.log("addBookmark failed:", res.status, raw);
      if (!silent) alert(`ë¶ë§ˆí¬ ì‹¤íŒ¨ (${res.status})`);
      return false;
    }

    async function removeBookmark(quoteId, { silent = false } = {}) {
      if (!token()) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      setQuoteStatus("ë¶ë§ˆí¬ í•´ì œ ì¤‘...");
      const res = await fetch(`/quote/${quoteId}/bookmark`, {
        method: "DELETE",
        headers: { ...authHeader() },
      });

      if (res.ok) {
        const data = await readJsonSafe(res);
        bookmarkedMap.delete(Number(quoteId));
        setQuoteStatus(data.message || "ë¶ë§ˆí¬ í•´ì œ ì™„ë£Œ!");
        if (!silent) alert(data.message || "ë¶ë§ˆí¬ í•´ì œ ì™„ë£Œ!");
        return true;
      }

      const raw = await res.text();
      setQuoteStatus(`í•´ì œ ì‹¤íŒ¨ (${res.status})`);
      console.log("removeBookmark failed:", res.status, raw);
      if (!silent) alert(`ë¶ë§ˆí¬ í•´ì œ ì‹¤íŒ¨ (${res.status})`);
      return false;
    }

    // ë‚´ ë¶ë§ˆí¬ ëª©ë¡ ë³´ê¸°
    async function fetchBookmarks() {
      const t = token();
      if (!t) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

      const res = await fetch("/quote/bookmark", {
        headers: { ...authHeader() },
      });

      if (!res.ok) {
        const raw = await res.text();
        alert(`ë¶ë§ˆí¬ ì¡°íšŒ ì‹¤íŒ¨ (${res.status})`);
        console.log("fetchBookmarks failed:", res.status, raw);
        return;
      }

      const quotes = await res.json();

      // ìºì‹œ ì—…ë°ì´íŠ¸(ë³„ í† ê¸€ ì •í™•ë„ â†‘)
      bookmarkedMap.clear();
      quotes.forEach(q => bookmarkedMap.set(Number(q.id), true));
      if (currentQuoteId != null) setBookmarkIcon(bookmarkedMap.get(currentQuoteId) === true);

      const list = document.getElementById("bookmark-list");
      list.classList.remove("hidden");

      if (quotes.length === 0) {
        list.innerHTML = "<p>â­ ì•„ì§ ë¶ë§ˆí¬í•œ ëª…ì–¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      list.innerHTML = quotes.map(q => `
        <div class="info-box">
          <div>"${escapeHtml(q.content)}"</div>
          <small style="display:block; margin-top:10px; text-align:right;">
            - ${escapeHtml(q.author || "ì‘ì ë¯¸ìƒ")}
          </small>
          <button class="btn-danger" style="margin-top:10px;" onclick="removeBookmark(${Number(q.id)})">
            âŒ ë¶ë§ˆí¬ í•´ì œ
          </button>
        </div>
      `).join("");
    }

    function hideBookmarks() {
      document.getElementById("bookmark-list").classList.add("hidden");
    }

    // ---------- QUESTION ----------
    function showCachedOrFetchQuestion() {
      const cached = readQuestionCache();
      if (cached && cached.question) {
        document.getElementById("daily-question").textContent = `ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ${cached.question}`;
        return;
      }
      fetchRandomQuestion();
    }

    async function fetchRandomQuestion() {
      if (!token()) {
        document.getElementById("daily-question").textContent = "ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: (ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤)";
        return;
      }

      const res = await fetch("/questions/random", {
        headers: { ...authHeader() },
      });

      if (!res.ok) {
        if (res.status === 400) {
          const cached = readQuestionCache();
          document.getElementById("daily-question").textContent =
            cached?.question
              ? `ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ${cached.question}`
              : "ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ì˜¤ëŠ˜ì€ ì§ˆë¬¸ì„ ì´ë¯¸ í•œë²ˆ ë°›ìœ¼ì…¨ìŠµë‹ˆë‹¤ ğŸ˜Š";
          return;
        }
        const raw = await res.text();
        document.getElementById("daily-question").textContent = `ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: (ìš”ì²­ ì‹¤íŒ¨ ${res.status})`;
        console.log("/questions/random failed:", res.status, raw);
        return;
      }

      const data = await res.json();
      const q =
        data.content ||
        data.question ||
        data.text ||
        data.message ||
        (data.data && (data.data.content || data.data.question || data.data.text));

      if (!q) {
        document.getElementById("daily-question").textContent = "ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: (ë°ì´í„° í˜•ì‹ì´ ë‹¤ë¦…ë‹ˆë‹¤. ì½˜ì†” í™•ì¸)";
        console.log("questions/random unknown shape:", data);
        return;
      }

      document.getElementById("daily-question").textContent = `ğŸ¤” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ${q}`;
      writeQuestionCache(q);
    }

    // ---------- DIARY ----------
    async function fetchDiaries() {
      if (!token()) return;

      const res = await fetch("/v1/diary/", {
        headers: { ...authHeader() },
      });

      if (!res.ok) {
        const raw = await res.text();
        console.log("/v1/diary/ failed:", res.status, raw);
        return;
      }

      const diaries = await res.json();
      const list = document.getElementById("diary-list");
      list.innerHTML = diaries.length ? "" : "<p>ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";

      diaries.forEach((d) => {
        const item = document.createElement("div");
        item.className = "diary-item";

        item.innerHTML = `
          <div>
            <strong>${escapeHtml(d.title)}</strong><br>
            <small>${escapeHtml(d.content)}</small>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="edit-btn">ìˆ˜ì •</button>
            <button class="del-btn btn-danger">ì‚­ì œ</button>
          </div>
        `;

        item.querySelector(".edit-btn").addEventListener("click", () => updateDiary(d.id, d.title, d.content));
        item.querySelector(".del-btn").addEventListener("click", () => deleteDiary(d.id));
        list.appendChild(item);
      });
    }

    async function createDiary() {
      const title = document.getElementById("diary-title").value;
      const content = document.getElementById("diary-content").value;

      const res = await fetch("/v1/diary/", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeader() },
        body: JSON.stringify({ title, content }),
      });

      if (!res.ok) {
        const raw = await res.text();
        alert(`ì¼ê¸° ìƒì„± ì‹¤íŒ¨ (${res.status})`);
        console.log("createDiary failed:", res.status, raw);
        return;
      }

      document.getElementById("diary-title").value = "";
      document.getElementById("diary-content").value = "";
      fetchDiaries();
    }

    async function updateDiary(id, oldT, oldC) {
      const title = prompt("ìˆ˜ì •í•  ì œëª©:", oldT);
      const content = prompt("ìˆ˜ì •í•  ë‚´ìš©:", oldC);
      if (title === null && content === null) return;

      const res = await fetch(`/v1/diary/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", ...authHeader() },
        body: JSON.stringify({
          title: title === null ? oldT : title,
          content: content === null ? oldC : content,
        }),
      });

      if (!res.ok) {
        const raw = await res.text();
        alert(`ì¼ê¸° ìˆ˜ì • ì‹¤íŒ¨ (${res.status})`);
        console.log("updateDiary failed:", res.status, raw);
        return;
      }

      fetchDiaries();
    }

    async function deleteDiary(id) {
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      const res = await fetch(`/v1/diary/${id}`, {
        method: "DELETE",
        headers: { ...authHeader() },
      });

      if (!res.ok) {
        const raw = await res.text();
        alert(`ì¼ê¸° ì‚­ì œ ì‹¤íŒ¨ (${res.status})`);
        console.log("deleteDiary failed:", res.status, raw);
        return;
      }

      fetchDiaries();
    }
  </script>
</body>
</html>
